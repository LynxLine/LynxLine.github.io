<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Lab 23, hard disk or SD card</title>
    <meta name="description" content="">
    <meta name="keywords" content='Blog, Inferno OS, Raspberry Pi, Research'>

    <meta property="og:url" content="https://lynxline.com/posts/lab-23-hard-disk-or-sd-card/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Lab 23, hard disk or SD card">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://lynxline.com/images/lynx.jpg">
    <meta property="og:image:secure_url" content="https://lynxline.com/images/lynx.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Lab 23, hard disk or SD card">
    <meta name="twitter:description" content="">
    <meta property="twitter:domain" content="https://lynxline.com/posts/lab-23-hard-disk-or-sd-card/">
    <meta property="twitter:url" content="https://lynxline.com/posts/lab-23-hard-disk-or-sd-card/">
    <meta name="twitter:image" content="https://lynxline.com/images/lynx.jpg">

    
    <link rel="canonical" href="https://lynxline.com/posts/lab-23-hard-disk-or-sd-card/" />

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.c60dbb422ed053b0761160e3a3f08b9af2060f00adc8f12c0ff21a8cf55b3d8e.js" integrity="sha256-xg27Qi7QU7B2EWDjo/CLmvIGDwCtyPEsD/IajPVbPY4="></script>

    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://lynxline.com/">
                <img src='/images/lynx.jpg' alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://lynxline.com/">LynxLine</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://lynxline.com/services/"><span data-feather='zap'></span> Services </a>
            </div>
            
            <div class="nav-link">
                <a href="https://lynxline.com/posts/"><span data-feather='layers'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://lynxline.com/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://lynxline.com/contact/"><span data-feather='mail'></span> Contact </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://lynxline.com/services/"><span data-feather='zap'></span> Services </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://lynxline.com/posts/"><span data-feather='layers'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://lynxline.com/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://lynxline.com/contact/"><span data-feather='mail'></span> Contact </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Lab 23, hard disk or SD card</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">January 2, 2014
        
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://lynxline.com/tags/blog">Blog</a></li>
        
            <li class="post-tag"><a href="https://lynxline.com/tags/inferno-os">Inferno OS</a></li>
        
            <li class="post-tag"><a href="https://lynxline.com/tags/raspberry-pi">Raspberry Pi</a></li>
        
            <li class="post-tag"><a href="https://lynxline.com/tags/research">Research</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>Before this Lab, the only way to bypass information to our Raspberry Pi machine, was the TFTP which downloads kernel from development machine (used Mac). Because kernel also includes root filesystem, we can embed some files there to have minimal read-only filesystem which allows to run dis files and do some testing, like experimenting with USB support, etc.</p>
<p>Sure, there were no way to do something and keep results on storage as there is no one. In this lab we try to create a partition to have possibility to save files.</p>
<p>xxx</p>
<p>Let’s start:
First I compared files in <strong>port/</strong> versus same in Plan9. Inferno’s versions were more old, so I used <strong>sd.h</strong> and <strong>devsd.c</strong> from Plan9. Inferno does not have <strong>port/sdmmc.c</strong>, so this one was also added. Examined with compilation in Inferno environment and applied few trivial changes (like <em>up-&gt;errstr</em> to <em>up-&gt;env-&gt;errstr</em>). That was minor.</p>
<p>Now codes specific to Raspberry: we borrow from 9pi. We need <strong>dma.c</strong> as it is time that we use the DMA for fast data transfer from SD. <strong>emmc.c</strong> written by Richard Miller for 9pi for bcm2835 mass media controller. Modify <strong>rpi</strong> spec file to include <em>sd</em> in <em>dev</em> section, <em>dma</em> and <em>sdmmc emmc</em> into <em>misc</em> section. Add <strong>/dis/disk/*.dis</strong>, <strong>zeros</strong>, <strong>dd</strong> to embedded filesystem.</p>
<p>Some changes are needed for our header files: in <strong>mem.h</strong> we need specify <em>#define BUSIO</em> to have controller communications. That should have addresses as seen from the videocore gpu, which was my fault as I thought same address as <em>PHYSIO</em>, but fixed later.</p>
<p>Add Devport and DevConf to <strong>dat.h</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#75715e"> *  hardware info about a device
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        ulong   port;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#66d9ef">int</span>     size;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>} Devport;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#66d9ef">struct</span> DevConf
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        ulong   intnum;                 <span style="color:#75715e">/* interrupt number */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#66d9ef">char</span>    <span style="color:#f92672">*</span>type;                  <span style="color:#75715e">/* card type, malloced */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#66d9ef">int</span>     nports;                 <span style="color:#75715e">/* Number of ports */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        Devport <span style="color:#f92672">*</span>ports;                 <span style="color:#75715e">/* The ports themselves */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>};
</span></span></code></pre></div><p>Add SD card dev file server bind to <strong>rpiinit.b</strong> to see it on device:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#a6e22e">sys</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">bind</span>(<span style="color:#e6db74">&#34;#S&#34;</span>, <span style="color:#e6db74">&#34;/dev&#34;</span>, <span style="color:#a6e22e">sys</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">MAFTER</span>);   <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">sdcard</span> <span style="color:#a6e22e">subsystem</span>
</span></span></code></pre></div><p>Try to compile, all looks okay. Attempt to boot and see message:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>eMMC external clock 50 MHz
</span></span></code></pre></div><p>Have a look at <strong>/dev</strong>, there is <strong>/dev/sdM0/</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>/dev/sdM0/ctl
</span></span><span style="display:flex;"><span>/dev/sdM0/data
</span></span><span style="display:flex;"><span>/dev/sdM0/raw
</span></span></code></pre></div><p>To see partition table we use <strong>disk/fdisk</strong> from Inferno. Amazing, but it work ok:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>$ disk/fdisk /dev/sdM0/data
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; p
</span></span><span style="display:flex;"><span>cylinder = 1936384 bytes
</span></span><span style="display:flex;"><span>   p1                    0 66         (66 cylinders, 121.88 MB) FAT32LBA
</span></span><span style="display:flex;"><span>   p2                   66 595        (529 cylinders, 976.89 MB) LINUX
</span></span><span style="display:flex;"><span>   p3                  595 859        (264 cylinders, 487.52 MB) LINUXSWAP
</span></span><span style="display:flex;"><span>   empty               859 2047       (1188 cylinders, 2.14 GB)
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Looks like I have SD card with some linux onboard. If we would like to see partitions as files in <strong>/dev/sdM0/</strong>, we just do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>$ disk/fdisk -p /dev/sdM0/data &gt; /dev/sdM0/ctl
</span></span><span style="display:flex;"><span>$ ls /dev/sdM0
</span></span><span style="display:flex;"><span>/dev/sdM0/ctl
</span></span><span style="display:flex;"><span>/dev/sdM0/data
</span></span><span style="display:flex;"><span>/dev/sdM0/dos
</span></span><span style="display:flex;"><span>/dev/sdM0/linux
</span></span><span style="display:flex;"><span>/dev/sdM0/raw
</span></span></code></pre></div><p>Now about filesystem that we can use as root of our system. This is <strong>kfs</strong> which is used in Plan9 and Inferno. It has some limitations as 27 bytes per filename. First I come back to my Mac, inserted SD card and by using Mac fdisk changed type Linux partition to <strong>39</strong> (Plan9). Then as I see size of partition in bytes I created with <strong>dd if=/dev/zero</strong> same length file. Started emu (mac hosted inferno) and tried to initialize and mount the file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>; mount -c {disk/kfs -r -b 8192 kfs.file} /n/local
</span></span></code></pre></div><p>using 8KB as block size.
Then I just copied whole Inferno folder content to SD partition:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>; cp -r * /n/local/
</span></span><span style="display:flex;"><span>cp: cannot create /n/local//os/rpi/labs/lab-03-rpi-booting-process.pdf: name too long
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Yep, some filenames are too long, but it is okay for now.
Unmount, put SD back into raspberry, boot, again initialize <strong>ctl</strong> with fdisk and try to mount:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>$ mount -c {disk/kfs /dev/sdM0/plan9} /n/local
</span></span><span style="display:flex;"><span>mount: can&#39;t dial net!{disk/kfs!styx: %q% /net.alt (/net.alt/net/clone)
</span></span></code></pre></div><p>Strange, feel dumb, but we used <strong>tinysh.dis</strong> as our shell and it can not do <strong>{}</strong>, I guess copied from <strong>ipaq</strong> spec file with assumption that it needs less dependencies. So fix <strong>rpi</strong> spec file to use real <strong>sh.dis</strong> as our shell and:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>; mount -c {disk/kfs -A -n main /dev/sdM0/plan9} /n/local
</span></span><span style="display:flex;"><span>kfs needs check
</span></span><span style="display:flex;"><span>kfs: initializing minimal user table
</span></span><span style="display:flex;"><span>; ls /n/local
</span></span><span style="display:flex;"><span>/n/local/.DS_Store
</span></span><span style="display:flex;"><span>/n/local/.hg
</span></span><span style="display:flex;"><span>/n/local/.hgignore
</span></span><span style="display:flex;"><span>/n/local/.hgtags
</span></span><span style="display:flex;"><span>/n/local/CHANGES
</span></span><span style="display:flex;"><span>/n/local/DragonFly
</span></span><span style="display:flex;"><span>/n/local/FreeBSD
</span></span><span style="display:flex;"><span>/n/local/INSTALL
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Wow, we have filesystem mounted!
Later we may need specific procedure to actually create root filesystem with only needed stuff.</p>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>

    
    
    
</div>



    

        </main><footer class="footer">
    
    

    
    <span>
        Made using <a target="_blank" href="https://gohugo.io/">HUGO</a>
    </span>
</footer>
</body>
</html>
